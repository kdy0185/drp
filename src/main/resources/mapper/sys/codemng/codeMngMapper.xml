<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jsplan.drp.sys.codemng.CodeMngMapper">

	<!-- 페이징 설정 -->
	<sql id="paginationHeader">
		SELECT *
			FROM (
	</sql>
	<sql id="paginationFooter">
			) DATA
		WHERE RN BETWEEN #{startIndex} AND #{endIndex}
	</sql>

	<!-- 검색 조건 -->
	<sql id="grpSearch">
		<if test="grpCd != null and grpCd != ''">
			AND GRP_CD = #{grpCd}
		</if>
		<if test="searchWord != null and searchWord != ''">
			<if test="searchCd == 'grpCd'">
				AND LTRIM(RTRIM(REPLACE(UPPER(GRP_CD), ' ', ''))) LIKE '%' + LTRIM(RTRIM(REPLACE(UPPER(#{searchWord}), ' ', ''))) + '%'
			</if>
			<if test="searchCd == 'grpNm'">
				AND LTRIM(RTRIM(REPLACE(UPPER(GRP_NM), ' ', ''))) LIKE '%' + LTRIM(RTRIM(REPLACE(UPPER(#{searchWord}), ' ', ''))) + '%'
			</if>
		</if>
	</sql>
	<sql id="codeSearch">
		<if test="grpCd != null and grpCd != ''">
			AND A.GRP_CD = #{grpCd}
		</if>
		<if test="comCd != null and comCd != ''">
			AND B.COM_CD = #{comCd}
		</if>
		<if test="useYn != null and useYn != ''">
			AND B.USE_YN = #{useYn}
		</if>
		<if test="searchWord != null and searchWord != ''">
			<if test="searchCd == 'grpCd'">
				AND LTRIM(RTRIM(REPLACE(UPPER(A.GRP_CD), ' ', ''))) LIKE '%' + LTRIM(RTRIM(REPLACE(UPPER(#{searchWord}), ' ', ''))) + '%'
			</if>
			<if test="searchCd == 'grpNm'">
				AND LTRIM(RTRIM(REPLACE(UPPER(A.GRP_NM), ' ', ''))) LIKE '%' + LTRIM(RTRIM(REPLACE(UPPER(#{searchWord}), ' ', ''))) + '%'
			</if>
			<if test="searchCd == 'comCd'">
				AND LTRIM(RTRIM(REPLACE(UPPER(B.COM_CD), ' ', ''))) LIKE '%' + LTRIM(RTRIM(REPLACE(UPPER(#{searchWord}), ' ', ''))) + '%'
			</if>
			<if test="searchCd == 'comNm'">
				AND LTRIM(RTRIM(REPLACE(UPPER(B.COM_NM), ' ', ''))) LIKE '%' + LTRIM(RTRIM(REPLACE(UPPER(#{searchWord}), ' ', ''))) + '%'
			</if>
		</if>
	</sql>

	<!-- 그룹 코드 목록 -->
	<select id="selectGrpMngList" resultType="codeMngVO">
		<include refid="paginationHeader" />
			SELECT ROW_NUMBER() OVER(ORDER BY GRP_NM) rn,
				   GRP_CD               grpCd,
				   GRP_CD               exGrpCd,
				   GRP_NM               grpNm,
				   USE_YN               useYn,
				   DETL                 detl
			FROM   SYS_GRP_CODE
			WHERE  1 = 1
				<include refid="grpSearch" />
		<include refid="paginationFooter" />
	</select>

	<!-- 그룹 코드 목록 수 -->
	<select id="selectGrpMngListCnt" resultType="int">
		SELECT COUNT(*)
		FROM SYS_GRP_CODE
		WHERE 1 = 1
			<include refid="grpSearch" />
	</select>

	<!-- 공통 코드 목록 -->
	<select id="selectCodeMngList" resultType="codeMngVO">
		<include refid="paginationHeader" />
			SELECT ROW_NUMBER() OVER(ORDER BY B.ORD) rn,
			       A.GRP_CD            grpCd,
			       A.GRP_NM            grpNm,
			       B.COM_CD            comCd,
			       B.COM_CD            exComCd,
			       B.COM_NM            comNm,
			       B.USE_YN            useYn,
			       B.DETL              detl,
			       B.ORD               ord
			FROM   (SELECT GRP_CD,
			               GRP_NM
			        FROM   SYS_GRP_CODE) A
			       INNER JOIN (SELECT GRP_CD,
			                          COM_CD,
			                          COM_NM,
			                          USE_YN,
			                          DETL,
			                          ORD
			                   FROM   SYS_COM_CODE) B
			               ON A.GRP_CD = B.GRP_CD
			WHERE  1 = 1
				<include refid="codeSearch" /> 
		<include refid="paginationFooter" />
	</select>

	<!-- 공통 코드 목록 수 -->
	<select id="selectCodeMngListCnt" resultType="int">
		SELECT COUNT(*)
		FROM   (SELECT GRP_CD,
		               GRP_NM
		        FROM   SYS_GRP_CODE) A
		       INNER JOIN (SELECT GRP_CD,
		                          COM_CD,
		                          COM_NM,
		                          USE_YN,
		                          DETL,
		                          ORD
		                   FROM   SYS_COM_CODE) B
		               ON A.GRP_CD = B.GRP_CD
		WHERE  1 = 1
			<include refid="codeSearch" /> 
	</select>

	<!-- 그룹 코드 등록 -->
	<update id="insertGrpMngData">
		INSERT INTO SYS_GRP_CODE
		(GRP_CD,
		 GRP_NM,
		 USE_YN,
		 <if test="detl != null and detl != ''">
		   DETL,
		 </if>
		 REG_USER,
		 REG_DATE)
		VALUES (#{grpCd},
						#{grpNm},
						#{useYn},
						<if test="detl != null and detl != ''">
						  #{detl},
						</if>
						#{loginId},
						GETDATE())
	</update>

	<!-- 공통 코드 등록 -->
	<update id="insertCodeMngData">
		INSERT INTO SYS_COM_CODE
		(GRP_CD,
		 COM_CD,
		 COM_NM,
		 USE_YN,
		 <if test="detl != null and detl != ''">
		   DETL,
		 </if>
		 ORD,
		 REG_USER,
		 REG_DATE)
		VALUES (#{grpCd},
						#{comCd},
						#{comNm},
						#{useYn},
						<if test="detl != null and detl != ''">
						  #{detl},
						</if>
						#{ord},
						#{loginId},
						GETDATE())
	</update>

	<!-- 그룹 코드 상세 -->
	<select id="selectGrpMngDetail" parameterType="codeMngVO" resultType="codeMngVO">
		SELECT GRP_CD                           grpCd,
					 GRP_NM                           grpNm,
					 USE_YN                           useYn,
					 DETL                             detl,
					 DBO.FN_GET_DRP_USER_NM(REG_USER) regUser,
					 CONVERT(VARCHAR, REG_DATE, 120)  regDate,
					 DBO.FN_GET_DRP_USER_NM(MOD_USER) modUser,
					 CONVERT(VARCHAR, MOD_DATE, 120)  modDate
		FROM SYS_GRP_CODE
		WHERE GRP_CD = #{grpCd}
	</select>

	<!-- 공통 코드 상세 -->
	<select id="selectCodeMngDetail" parameterType="codeMngVO" resultType="codeMngVO">
		SELECT A.GRP_CD                           grpCd,
					 A.GRP_NM                           grpNm,
					 B.COM_CD                           comCd,
					 B.COM_NM                           comNm,
					 B.USE_YN                           useYn,
					 B.DETL                             detl,
					 B.ORD                              ord,
					 DBO.FN_GET_DRP_USER_NM(B.REG_USER) regUser,
					 CONVERT(VARCHAR, B.REG_DATE, 120)  regDate,
					 DBO.FN_GET_DRP_USER_NM(B.MOD_USER) modUser,
					 CONVERT(VARCHAR, B.MOD_DATE, 120)  modDate
		FROM (SELECT GRP_CD, GRP_NM
					FROM SYS_GRP_CODE) A
					 INNER JOIN (SELECT GRP_CD,
															COM_CD,
															COM_NM,
															USE_YN,
															DETL,
															ORD,
															REG_USER,
															REG_DATE,
															MOD_USER,
															MOD_DATE
											 FROM SYS_COM_CODE) B
											ON A.GRP_CD = B.GRP_CD
		WHERE A.GRP_CD = #{grpCd}
			AND B.COM_CD = #{comCd}
	</select>

	<!-- 그룹 코드 수정 -->
	<update id="updateGrpMngData">
		UPDATE SYS_GRP_CODE
		SET GRP_CD = #{grpCd},
				GRP_NM = #{grpNm},
				USE_YN = #{useYn},
				<if test="detl != null and detl != ''">
				  DETL = #{detl},
				</if>
				<if test="detl == null or detl == ''">
				  DETL = NULL,
				</if>
				MOD_USER = #{loginId},
				MOD_DATE = GETDATE()
		WHERE GRP_CD = #{exGrpCd}
	</update>

	<!-- 공통 코드 수정 -->
	<update id="updateCodeMngData">
		UPDATE SYS_COM_CODE
		SET COM_CD = #{comCd},
				COM_NM = #{comNm},
				USE_YN = #{useYn},
				<if test="detl != null and detl != ''">
				  DETL = #{detl},
				</if>
				<if test="detl == null or detl == ''">
				  DETL = NULL,
				</if>
				ORD = #{ord},
				MOD_USER = #{loginId},
				MOD_DATE = GETDATE()
		WHERE GRP_CD = #{grpCd}
			AND COM_CD = #{exComCd}
	</update>

	<!-- 그룹 코드 삭제 -->
	<delete id="deleteGrpMngData">
		DELETE FROM SYS_GRP_CODE
		WHERE  GRP_CD = #{grpCd}
	</delete>

	<!-- 공통 코드 삭제 -->
	<delete id="deleteCodeMngData">
		DELETE FROM SYS_COM_CODE
		WHERE  GRP_CD = #{grpCd}
		       AND COM_CD = #{comCd}
	</delete>

	<!-- 그룹 코드 엑셀 목록 -->
	<select id="selectGrpMngExcelList" resultType="codeMngVO">
		SELECT ROW_NUMBER() OVER(ORDER BY GRP_NM)     rn,
		       GRP_CD                                 grpCd,
		       GRP_NM                                 grpNm,
		       CASE USE_YN
		         WHEN 'Y' THEN '사용'
		         WHEN 'N' THEN '미사용'
		       END                                    useYn,
		       DETL                                   detl,
		       DBO.FN_GET_DRP_USER_NM(REG_USER)       regUser,
		       CONVERT(DATE, REG_DATE)                regDate,
		       DBO.FN_GET_DRP_USER_NM(MOD_USER)       modUser,
		       CONVERT(DATE, MOD_DATE)                modDate
		FROM   SYS_GRP_CODE
		WHERE  1 = 1
			<include refid="grpSearch" /> 
	</select>

	<!-- 공통 코드 엑셀 목록 -->
	<select id="selectCodeMngExcelList" resultType="codeMngVO">
		SELECT ROW_NUMBER() OVER(ORDER BY B.ORD)                 rn,
		       A.GRP_CD                            grpCd,
		       A.GRP_NM                            grpNm,
		       B.COM_CD                            comCd,
		       B.COM_NM                            comNm,
		       CASE B.USE_YN
		         WHEN 'Y' THEN '사용'
		         WHEN 'N' THEN '미사용'
		       END                                 useYn,
		       B.DETL                              detl,
		       B.ORD                               ord,
		       DBO.FN_GET_DRP_USER_NM(B.REG_USER)  regUser,
		       CONVERT(DATE, B.REG_DATE)           regDate,
		       DBO.FN_GET_DRP_USER_NM(B.MOD_USER)  modUser,
		       CONVERT(DATE, B.MOD_DATE)           modDate
		FROM   (SELECT GRP_CD,
		               GRP_NM
		        FROM   SYS_GRP_CODE) A
		       INNER JOIN (SELECT GRP_CD,
		                          COM_CD,
		                          COM_NM,
		                          USE_YN,
		                          DETL,
		                          ORD,
		                          REG_USER,
		                          REG_DATE,
		                          MOD_USER,
		                          MOD_DATE
		                   FROM   SYS_COM_CODE) B
		               ON A.GRP_CD = B.GRP_CD
		WHERE  1 = 1
			<include refid="codeSearch" /> 
	</select>

</mapper>
