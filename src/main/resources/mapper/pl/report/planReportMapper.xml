<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jsplan.drp.domain.pl.report.PlanReportMapper">

	<!-- 페이징 설정 -->
	<sql id="paginationHeader">
		SELECT *
			FROM (
	</sql>
	<sql id="paginationFooter">
			) DATA
		WHERE RN BETWEEN #{startIndex} AND #{endIndex}
	</sql>

	<!-- 검색 조건 -->
	<sql id="planReportSearch">
		<if test="userId != null and userId != ''">
			AND B.PLAN_USER = #{userId}
		</if>
		<if test="rtneStartDate != null and rtneStartDate != ''">
			AND A.RTNE_DATE &gt;= #{rtneStartDate}
		</if>
		<if test="rtneEndDate != null and rtneEndDate != ''">
			AND A.RTNE_DATE &lt;= #{rtneEndDate}
		</if>
		<if test="rtneCtgCd != null and rtneCtgCd != ''">
			AND B.RTNE_CTG_CD = #{rtneCtgCd}
		</if>
		<if test="rtneNm != null and rtneNm != ''">
			AND LTRIM(RTRIM(REPLACE(UPPER(A.RTNE_NM), ' ', ''))) LIKE '%' + LTRIM(RTRIM(REPLACE(UPPER(#{rtneNm}), ' ', ''))) + '%'
		</if>
	</sql>

	<!-- 분류 목록 -->
	<select id="selectPlanReportRtneCtgList" resultType="planReportVO">
		SELECT RTNE_CTG_CD rtneCtgCd,
					 RTNE_CTG_NM rtneCtgNm
		FROM PL_RTNE_CTG
		WHERE 1 = 1
			AND PLAN_USER = #{userId}
	</select>

	<!-- 일과 목록 -->
	<select id="selectPlanReportList" resultType="planReportVO">
		<include refid="paginationHeader" />
			SELECT ROW_NUMBER() OVER(ORDER BY A.RTNE_CD) rn,
						 A.RTNE_CD                                     rtneCd,
						 A.RTNE_DATE                                   rtneDate,
						 A.RTNE_ORD                                    rtneOrd,
						 CONVERT(VARCHAR(16), A.RTNE_START_DATE, 120) + ' ~ '
						 + CONVERT(VARCHAR(16), A.RTNE_END_DATE, 120)  rtneStartDate,
						 B.RTNE_CTG_NM                                 rtneCtgNm,
						 A.RTNE_NM                                     rtneNm,
						 CONVERT(VARCHAR, A.ACHV_RATE) + '%'           achvRate,
						 DBO.FN_GET_CODE_NM('CONC_RATE', A.CONC_RATE)  concRate,
						 A.PLAN_USER                                   planUser
			FROM   (SELECT RTNE_CD,
										 RTNE_DATE,
										 RTNE_ORD,
										 RTNE_CTG_CD,
										 RTNE_START_DATE,
										 RTNE_END_DATE,
										 RTNE_NM,
										 ACHV_RATE,
										 CONC_RATE,
										 PLAN_USER
							FROM   PL_RTNE) A
						 INNER JOIN (SELECT RTNE_CTG_CD,
																RTNE_CTG_NM,
																PLAN_USER
												 FROM   PL_RTNE_CTG) B
										 ON A.RTNE_CTG_CD = B.RTNE_CTG_CD
												AND A.PLAN_USER = B.PLAN_USER
			WHERE  1 = 1
				<include refid="planReportSearch" />
		<include refid="paginationFooter" />
	</select>

	<!-- 일과 목록 수 -->
	<select id="selectPlanReportListCnt" resultType="int">
		SELECT COUNT(*)
		FROM   (SELECT RTNE_CD,
									 RTNE_DATE,
									 RTNE_ORD,
									 RTNE_CTG_CD,
									 RTNE_START_DATE,
									 RTNE_END_DATE,
									 RTNE_NM,
									 ACHV_RATE,
									 CONC_RATE,
									 PLAN_USER
						FROM   PL_RTNE) A
					 INNER JOIN (SELECT RTNE_CTG_CD,
															RTNE_CTG_NM,
															PLAN_USER
											 FROM   PL_RTNE_CTG) B
									 ON A.RTNE_CTG_CD = B.RTNE_CTG_CD
											AND A.PLAN_USER = B.PLAN_USER
		WHERE  1 = 1
			<include refid="planReportSearch" />
	</select>

	<!-- 일과 엑셀 목록 -->
	<select id="selectPlanReportExcelList" resultType="planReportVO">
		SELECT ROW_NUMBER() OVER(ORDER BY A.RTNE_CD) rn,
					 A.RTNE_CD                                     rtneCd,
					 A.RTNE_DATE                                   rtneDate,
					 A.RTNE_ORD                                    rtneOrd,
					 CONVERT(VARCHAR(16), A.RTNE_START_DATE, 120) + ' ~ '
					 + CONVERT(VARCHAR(16), A.RTNE_END_DATE, 120)  rtneStartDate,
					 B.RTNE_CTG_NM                                 rtneCtgNm,
					 A.RTNE_NM                                     rtneNm,
					 CONVERT(VARCHAR, A.ACHV_RATE) + '%'           achvRate,
					 DBO.FN_GET_CODE_NM('CONC_RATE', A.CONC_RATE)  concRate,
					 A.PLAN_USER                                   planUser
		FROM   (SELECT RTNE_CD,
									 RTNE_DATE,
									 RTNE_ORD,
									 RTNE_CTG_CD,
									 RTNE_START_DATE,
									 RTNE_END_DATE,
									 RTNE_NM,
									 ACHV_RATE,
									 CONC_RATE,
									 PLAN_USER
						FROM   PL_RTNE) A
					 INNER JOIN (SELECT RTNE_CTG_CD,
															RTNE_CTG_NM,
															PLAN_USER
											 FROM   PL_RTNE_CTG) B
									 ON A.RTNE_CTG_CD = B.RTNE_CTG_CD
											AND A.PLAN_USER = B.PLAN_USER
		WHERE  1 = 1
			<include refid="planReportSearch" />
	</select>

</mapper>
